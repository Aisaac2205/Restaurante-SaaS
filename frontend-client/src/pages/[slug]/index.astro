---
import Layout from "@/layouts/Layout.astro";
import HeaderV1 from "@/components/astro/Header.astro";
import HeaderV2 from "@/components/themes/v2-elegant/Header.astro";
// V1 IMPORTS (Urban)
import { LandingHero as HeroV1 } from "@/components/themes/v1-urban/Hero";
import { ContentSection as ContentV1 } from "@/components/themes/v1-urban/Content";
import { MenuPreviewSlider as MenuPreviewV1 } from "@/components/themes/v1-urban/MenuPreview";
import { VideoSection as VideoV1 } from "@/components/themes/v1-urban/Video";
import { ServicesSection as ServicesV1 } from "@/components/themes/v1-urban/Services";
import { InstagramFeed as InstagramV1 } from "@/components/themes/v1-urban/Instagram";
import { PremiumFooter as FooterV1 } from "@/components/themes/v1-urban/Footer";

// V2 IMPORTS (Elegant)
import { Hero as HeroV2 } from "@/components/themes/v2-elegant/Hero";
import { Menu as MenuListV2 } from "@/components/themes/v2-elegant/menu/Menu";
import { MenuPreviewSlider as MenuPreviewV2 } from "@/components/themes/v2-elegant/MenuPreview";
import { VideoSection as VideoV2 } from "@/components/themes/v2-elegant/Video";
import { InstagramFeed as InstagramV2 } from "@/components/themes/v2-elegant/Instagram";
import { ContentSection as ContentV2 } from "@/components/themes/v2-elegant/Content";
import { ServicesSection as ServicesV2 } from "@/components/themes/v2-elegant/Services";
import FooterV2 from "@/components/themes/v2-elegant/Footer.astro";
import { CartButton } from "@/components/react/CartButton";
import { CartDrawer } from "@/components/react/CartDrawer";
import type { PublicMenu } from "@/types";

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

// Fetch restaurant data from backend API
let menuData: PublicMenu | null = null;

try {
    const API_URL = import.meta.env.API_URL || "http://localhost:3000/api";
    const response = await fetch(`${API_URL}/menu/${slug}`);

    if (!response.ok) {
        if (response.status === 404) return Astro.redirect("/404");
        throw new Error("Failed to fetch data");
    }

    menuData = await response.json();
} catch (e) {
    console.error(e);
}

if (!menuData) {
    return Astro.redirect("/404");
}

const { restaurant, categories } = menuData;
const features = restaurant.features_config || {};
const menuLink = `/${slug}/menu`;
const themeMode = restaurant.theme_mode || "v1-urban";

// Toggleable sections (from Admin Panel)
const showVideo = features["feat_video"] === true;
const showServices = features["feat_services"] === true;

// Flatten products for MenuPreviewSlider
const allProducts = categories.flatMap((cat) => cat.products);
---

<Layout
    title={restaurant.name}
    primaryColor={restaurant.primary_color}
    logoUrl={restaurant.logo_url}
    restaurantPhone={restaurant.whatsapp_number}
    restaurantName={restaurant.name}
    enablePickup={restaurant.enable_pickup}
    enableDelivery={restaurant.enable_delivery}
    restaurantId={restaurant.id}
>
    {
        themeMode === "v1-urban" ? (
            <HeaderV1
                logoUrl={restaurant.logo_url}
                name={restaurant.name}
                menuLink={menuLink}
                homeLink={`/${slug}`}
                features={features}
            />
        ) : (
            <HeaderV2
                logoUrl={restaurant.logo_url}
                name={restaurant.name}
                menuLink={menuLink}
                homeLink={`/${slug}`}
                features={features}
                showVideo={showVideo}
                showServices={showServices}
            />
        )
    }

    <main>
        {
            themeMode === "v1-urban" ? (
                <>
                    {/* HERO V1 */}
                    <div id="hero">
                        <HeroV1
                            client:load
                            title={restaurant.hero_title || restaurant.name}
                            subtitle={restaurant.hero_subtitle}
                            bgImage={restaurant.hero_image_url}
                            primaryColor={restaurant.primary_color}
                            menuLink={menuLink}
                        />
                    </div>

                    {/* CONTENT SECTION */}
                    <div id="content">
                        <ContentV1
                            client:visible
                            image={restaurant.content_section_image}
                            title={restaurant.content_section_title}
                            body={restaurant.content_section_body}
                            menuLink={menuLink}
                        />
                    </div>

                    {/* SERVICES SECTION (Toggleable) */}
                    {showServices && (
                        <div id="services">
                            <ServicesV1
                                client:visible
                                services={restaurant.services_data}
                            />
                        </div>
                    )}

                    {/* MENU PREVIEW SLIDER */}
                    {allProducts.length > 0 && (
                        <MenuPreviewV1
                            client:visible
                            products={allProducts}
                            menuLink={menuLink}
                            slug={slug}
                        />
                    )}

                    {/* VIDEO SECTION (Toggleable) */}
                    {showVideo && (
                        <div id="video">
                            <VideoV1
                                client:visible
                                title={restaurant.video_section_title}
                                subtitle={restaurant.video_section_subtitle}
                                videoUrl={restaurant.video_url}
                                posterUrl={restaurant.video_poster_url}
                            />
                        </div>
                    )}

                    {/* INSTAGRAM FEED */}
                    <div id="instagram">
                        <InstagramV1
                            client:visible
                            username={restaurant.instagram_username}
                            images={restaurant.instagram_images || []}
                        />
                    </div>

                    {/* PREMIUM FOOTER */}
                    <FooterV1
                        restaurantName={restaurant.name}
                        logoUrl={restaurant.logo_url}
                        primaryColor={restaurant.primary_color}
                        contact={{
                            email: restaurant.email,
                            phone: restaurant.whatsapp_number,
                        }}
                        socials={{
                            instagram: restaurant.instagram_username,
                        }}
                    />
                </>
            ) : (
                <>
                    {/* THEME V2: ELEGANT */}
                    <HeroV2
                        client:load
                        title={restaurant.hero_title || restaurant.name}
                        subtitle={restaurant.hero_subtitle ?? ""}
                        bgImage={restaurant.hero_image_url ?? undefined}
                        primaryColor={restaurant.primary_color}
                        menuLink={menuLink}
                    />

                    {/* About / Content */}
                    <ContentV2
                        client:visible
                        image={restaurant.content_section_image}
                        title={restaurant.content_section_title}
                        body={restaurant.content_section_body}
                        menuLink={menuLink}
                    />

                    {/* Services */}
                    <ServicesV2
                        client:visible
                        services={restaurant.services_data}
                    />

                    {/* Menu Preview / Featured */}
                    <MenuPreviewV2
                        client:visible
                        products={allProducts}
                        menuLink={menuLink}
                    />

                    {/* Video Section */}
                    {showVideo && (
                        <VideoV2
                            client:only="react"
                            title={restaurant.video_section_title}
                            subtitle={restaurant.video_section_subtitle}
                            videoUrl={restaurant.video_url}
                            posterUrl={restaurant.video_poster_url}
                        />
                    )}

                    {/* Instagram */}
                    <InstagramV2
                        client:visible
                        username={restaurant.instagram_username}
                        images={restaurant.instagram_images || []}
                    />

                    {/* Footer V2 (Simple) */}
                    <FooterV2 restaurantName={restaurant.name} />
                </>
            )
        }
    </main>
</Layout>
