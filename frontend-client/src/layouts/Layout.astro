---
import { ViewTransitions } from "astro:transitions";
import "@/styles/global.css";
import { CartButton } from "@/components/react/CartButton";
import { CartDrawer } from "@/components/react/CartDrawer";

interface Props {
  title: string;
  description?: string;
  primaryColor: string;
  logoUrl?: string | null;
  // Cart Props
  enablePickup?: boolean;
  enableDelivery?: boolean;
  restaurantPhone?: string | null;
  restaurantName?: string;
  restaurantId?: number;
  // Menu Mode
  menuMode?: 'INTERACTIVE' | 'PDF';
}

const {
  title,
  description = "Men√∫ Digital",
  primaryColor,
  logoUrl,
  enablePickup = true,
  enableDelivery = false,
  restaurantPhone = "",
  restaurantName = "",
  restaurantId,
  menuMode = 'INTERACTIVE',
} = Astro.props;

// Default theme color if none provided, though API should provide it
const themeColor = primaryColor || "#000000";

const anim = {
  old: {
    name: "fadeOut",
    duration: "0.2s",
    easing: "ease-in-out",
    fillMode: "forwards",
  },
  new: {
    name: "fadeInUp",
    duration: "0.3s",
    easing: "ease-out",
    fillMode: "backwards",
  },
};

const customTransition = {
  forwards: anim,
  backwards: anim,
};
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="icon" type="image/svg+xml" href={logoUrl || "/favicon.svg"} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 text-gray-900 font-sans min-h-screen">
    <div
      id="load-progress"
      class="fixed top-0 left-0 h-1 z-50 bg-primary w-0 transition-all duration-300 ease-out opacity-0"
    >
    </div>

    <div transition:animate={customTransition}>
      <slot />
    </div>

    {/* Global Cart Islands - Only show in INTERACTIVE mode */}
    {
      restaurantPhone && menuMode === 'INTERACTIVE' && (
        <div transition:persist>
          <CartButton client:only="react" />
          <CartDrawer
            client:only="react"
            restaurantPhone={restaurantPhone}
            enablePickup={enablePickup}
            enableDelivery={enableDelivery}
            restaurantName={restaurantName}
            restaurantId={restaurantId}
          />
        </div>
      )
    }

    <script>
      const progress = document.getElementById("load-progress");

      if (progress) {
        document.addEventListener("astro:before-preparation", () => {
          progress.style.width = "30%";
          progress.style.opacity = "1";
        });

        document.addEventListener("astro:before-swap", () => {
          progress.style.width = "70%";
        });

        document.addEventListener("astro:after-swap", () => {
          progress.style.width = "100%";
          setTimeout(() => {
            progress.style.opacity = "0";
            setTimeout(() => {
              progress.style.width = "0%";
            }, 300);
          }, 200);
        });
      }
    </script>
  </body>
</html>

<style define:vars={{ themeColor }}>
  :root {
    --theme-color: var(--themeColor);
  }

  /* Global simple utility if needed, but Tailwind extends colors config to use var(--theme-color) */
  .text-primary {
    color: var(--theme-color);
  }
  .bg-primary {
    background-color: var(--theme-color);
  }
  .border-primary {
    border-color: var(--theme-color);
  }
</style>

<style is:global>
  /* Asegurar scroll suave */
  html {
    scroll-behavior: smooth;
  }

  /* Asegurar que las secciones tengan suficiente espacio */
  section[id] {
    scroll-margin-top: 80px; /* Altura del header */
  }

  div[id] {
    scroll-margin-top: 80px;
  }

  /* Hide scrollbar for clean horizontal scrolling */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
